<html>
  <head>
    <title>PeerJS3 Test</title>
    <script type="text/javascript" src="html2canvas.js"></script>
    <script type="text/javascript" src="peer.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script>
      // HTML2Canvas
      $(document).ready(function() {
        var dom = {};
        console.log(document.images);
        toAbsoluteURL(document.images);
        toAbsoluteURL(document.querySelectorAll("link[rel='stylesheet']"));
        toAbsoluteURL(document.scripts);

        var screenshot = document.documentElement.cloneNode(true);

        dom.size = {
          width: window.innerWidth || document.body.clientWidth,
          height: window.innerHeight || document.body.clientHeight,
        };

        screenshot.style.pointerEvents = "none";
        screenshot.style.overflow = "hidden";
        screenshot.style.userSelect = "none";
        screenshot.style.webkitUserSelect = "none";
        screenshot.style.MozUserSelect = "none";
        screenshot.setAttribute("unselectable", "on");

        var blob = new Blob([screenshot.outerHTML], {type: 'text/html'});
        var peer = new Peer('peer2', {host: 'localhost', port: 9000});
        var conn = peer.connect('peer1');
        dom.blob = window.URL.createObjectURL(blob);
        conn.on('open', function() {
          console.log("open");
          conn.send(dom);

        });

        console.log(screenshot.outerHTML);

        window.onscroll = function() {
          console.log("We scrolled");
          var conn = peer.connect('peer1');
          conn.on('open', function() {
            conn.send({
              scrollX: document.body.scrollLeft,
              scrollY: document.body.scrollTop
            });            
          });
        }

      });

      function toAbsoluteURL(obj) {
        console.log(obj);
        for (var i = 0; i < obj.length; i++) {
          console.log(obj[i].src);
          if (obj[i].src) {
            obj[i].src = obj[i].src;
          } else if (obj[i].href) {
            obj[i].href = obj[i].href;
          }
          console.log(obj[i]);
          //obj[i].src = "http://www.google.com";
          //console.log(obj[i])
        }
      }

      function rel_to_abs(url){
          /* Only accept commonly trusted protocols:
           * Only data-image URLs are accepted, Exotic flavours (escaped slash,
           * html-entitied characters) are not supported to keep the function fast */
        if(/^(https?|file|ftps?|mailto|javascript|data:image\/[^;]{2,9};):/i.test(url))
               return url; //Url is already absolute

          var base_url = location.href.match(/^(.+)\/?(?:#.+)?$/)[0]+"/";
          if(url.substring(0,2) == "//")
              return location.protocol + url;
          else if(url.charAt(0) == "/")
              return location.protocol + "//" + location.host + url;
          else if(url.substring(0,2) == "./")
              url = "." + url;
          else if(/^\s*$/.test(url))
              return ""; //Empty = Return nothing
          else url = "../" + url;

          url = base_url + url;
          var i=0
          while(/\/\.\.\//.test(url = url.replace(/[^\/]+\/+\.\.\//g,"")));

          /* Escape certain characters to prevent XSS */
          url = url.replace(/\.$/,"").replace(/\/\./g,"").replace(/"/g,"%22")
                  .replace(/'/g,"%27").replace(/</g,"%3C").replace(/>/g,"%3E");
          return url;
      }
    </script>
    <link type="text/css" rel="stylesheet" href="style.css">
    <style>
      body {
        font-family: 'Arial';
      }

      h1 {
        color: #FF0000;
      }
    </style>
  </head>
  <body>
    <h1>This is a really fancy site!</h1>
    <h2>So freaking fancy</h2>
    <h3>LOL HAHAHA</h3>
    <a href="www.google.com">Google</a><br />
    <a href="www.google.com">Google</a><br />
    <a href="www.google.com">Google</a><br />
    <a href="www.google.com">Google</a><br />
    <a href="www.google.com">Google</a><br />
    <a href="www.google.com">Google</a><br />
    <form>
      <input type="text" placeholder="type your name here" />
      <input type="text" placeholder="type your name here" />
      <input type="submit" value="Submit" />
    </form>

    <img src="cutie.jpg" />
    <img src="cutie.jpg" />
    <img src="http://images.nationalgeographic.com/wpf/media-live/photos/000/006/cache/macaw_617_600x450.jpg" />
  </body>
</html>